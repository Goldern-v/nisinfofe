<template>
  <div>
    <sweet-modal ref="modal" :modalWidth="500" title="出入量统计">
      <div class="time-type-button" v-if="HOSPITAL_ID=='liaocheng'">
        <el-button-group>
          <el-button :class="[active=='today'?'active-btn':'']" @click="initTime('today')">白班小结</el-button>
          <el-button :class="[active=='yesterday'?'active-btn':'']" @click="initTime('yesterday')">24小时小结</el-button>
        </el-button-group>
      </div>
      <!-- 北海 -->
       <div class="time-type-button" v-if="HOSPITAL_ID=='beihairenyi'">
        <el-button-group>
          <el-button :class="[active=='A'?'active-btn':'']" @click="beihaiInitTime('A')">A班小结</el-button>
          <el-button :class="[active=='P'?'active-btn':'']" @click="beihaiInitTime('P')">P班小结</el-button>
          <el-button :class="[active=='N'?'active-btn':'']" @click="beihaiInitTime('N')">N班小结</el-button>
          <el-button :class="[active=='ALL'?'active-btn':'']" @click="beihaiInitTime('ALL')">24h总结</el-button>
        </el-button-group>
      </div>
      <p for class="name-title">请选择日期区间：</p>
      <div flex="cross:center main:center" style="margin:0 15px 20px" v-if="HOSPITAL_ID==='fuyou'">
      <el-date-picker
      v-model="date[0]"
      type="datetime"
      format="yyyy-MM-dd HH:mm"
      placeholder="选择开始日期">
      </el-date-picker>
      <span style="padding: 0 15px; width: 30px">至</span>
      <el-date-picker
      v-model="date[1]"
      type="datetime"
      format="yyyy-MM-dd HH:mm:ss"
      placeholder="选择结束日期">
      </el-date-picker>
      </div>
      <div flex="cross:center main:center" style="margin:0 15px 20px" v-else>
        <cr-date-picker
          v-model="date[0]"
          type="datetime"
          format="yyyy-MM-dd HH:mm"
          placeholder="选择开始日期"
        ></cr-date-picker>
        <span style="padding: 0 15px; width: 30px">至</span>
        <cr-date-picker
          v-model="date[1]"
          type="datetime"
           format="yyyy-MM-dd HH:mm"
          placeholder="选择结束日期"
        ></cr-date-picker>
      </div>
      <p for class="name-title" flex="cross:center main:justify">
        <span>特殊情况处理：</span>
        <span class="activeText" @click="putGroupCount">分类合计</span>
      </p>
      <div style="margin: 0 15px" class="textarea-con">
        <el-input type="textarea" :rows="2" placeholder="请输入特殊情况处理" v-model="description"></el-input>
      </div>
      <div slot="button">
        <el-button class="modal-btn" @click="close">取消</el-button>
        <el-button class="modal-btn" type="primary" @click="post">计算</el-button>
      </div>
    </sweet-modal>
  </div>
</template>

<style lang="stylus" rel="stylesheet/stylus" type="text/stylus">
.noTimeCon .el-date-picker__editor-wrap:last-child
  pointer-events none
</style>

<style lang="stylus" rel="stylesheet/stylus" type="text/stylus" scoped>
.time-type-button
  text-align center;
.active-btn
  background-color #4bb08d
  color #fff
.name-title
  font-size 14px;
  margin 0px 0 15px
  font-weight bold
  padding-left 15px
  padding-right 15px
.activeText
  font-size 14px
  color rgb(40, 79, 194)
  cursor pointer
  font-weight normal
.textarea-con
  >>>textarea
    height 120px
</style>

<script>
import { outputSum } from "@/api/record";
import { putGroupCount } from "../../api/index.js";
import moment from "moment";
import bus from "vue-happy-bus";
import sheetInfo from "../config/sheetInfo/index.js";
export default {
  data() {
    return {
      date: [
        moment().format("YYYY-MM-DD HH:mm"),
        moment().format("YYYY-MM-DD HH:mm")
      ],
      description: "",
      bus: bus(this),
      active:'' // 顶部按钮激活状态(聊城)
    };
  },
  methods: {
    initTime(type){
      this.active = type
      let timeObject = {
        'today':[moment().format("YYYY-MM-DD 07:00"),moment().format("YYYY-MM-DD 17:00")],
        'yesterday':[moment().subtract(1,'days').format("YYYY-MM-DD 07:00"),moment().format("YYYY-MM-DD 07:00")]
      }
      this.date = timeObject[type]
    },
    beihaiInitTime(type){
       this.active=type
       let timeObject = {
        'A':[moment().format("YYYY-MM-DD 07:00"),moment().format("YYYY-MM-DD 15:00")],
        'P':[moment().format("YYYY-MM-DD 15:00"),moment().format("YYYY-MM-DD 23:00")],
        'N':[moment().subtract(1,'days').format("YYYY-MM-DD 23:00"),moment().format("YYYY-MM-DD 06:59")],
        'ALL':[moment().subtract(1,'days').format("YYYY-MM-DD 07:00"),moment().format("YYYY-MM-DD 07:00")]
      }
      this.date = timeObject[type]
    },
    open() {
      this.active = ''
      this.$refs.modal.open();
      this.description = "";
      let y = moment()
        .subtract(1, "days")
        .format("YYYY-MM-DD");
      let t = moment().format("YYYY-MM-DD");
      let yt = y + " 07:00";
      let tt = t + " 07:00";
      this.date = [yt, tt];
    },
    close() {
      this.$refs.modal.close();
    },
    post() {
      if (this.date[1]) {
        this.bus.$emit("saveSheetPage");
        setTimeout(() => {
          let date = this.date;
          let startTime = this.date[0];
          let endTime = this.date[1];
          let recordCode = sheetInfo.sheetType;
          outputSum(
            this.$parent.patientInfo.patientId,
            this.$parent.patientInfo.visitId,
            recordCode,
            startTime,
            endTime,
            this.description
          ).then(res => {
            this.bus.$emit("refreshSheetPage");
            this.$message({
              showClose: true,
              message: "计算成功",
              type: "success"
            });
            this.close();
          });
        }, 500);
      } else {
        this.$message({
          showClose: true,
          message: "请输入正确的时间"
        });
      }
    },
    putGroupCount() {
      let date = this.date;
      let startTime = this.date[0];
      let endTime = this.date[1];
      if(this.HOSPITAL_ID==="fuyou"){
        // el-date-picker的value-format不生效
        startTime=moment(startTime).format("YYYY-MM-DD HH:mm")
        endTime=moment(endTime).format("YYYY-MM-DD HH:mm")
      }
      putGroupCount(
        this.$parent.patientInfo.patientId,
        this.$parent.patientInfo.visitId,
        startTime,
        endTime
      ).then(res => {
        if (res.data.data.desc) {
          this.description = this.description + res.data.data.desc;
        } else {
          this.$message.warning("分类合计为空");
        }
      });
    }
  },
  components: {}
};
</script>
