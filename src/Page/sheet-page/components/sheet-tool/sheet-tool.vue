<template>
  <div>
    <div class="tool-contain" flex="cross:center">
      <div
        class="item-box"
        flex="cross:center main:center"
        @click="emit('addSheetPage')"
      >
        <div class="text-con">添加新页</div>
      </div>
      <!-- <div class="item-box" flex="cross:center main:center" flex-box="1" @click="emit('delSheetPage')">
            <div class="icon-box">
              <i class="icon-shanchu1 iconfont" style="font-size: 14px;color:#E55E01;"></i>
            </div>
            <div class="text-con">
              删除记录单
            </div>
      </div>-->
      <div
        class="item-box"
        flex="cross:center main:center"
        @click="emit('saveSheetPage', 'noSaveSign')"
      >
        <div class="text-con" flex="cross:center">保存</div>
      </div>
      <div
        class="item-box"
        flex="cross:center main:center"
        @click="openStaticModal"
        v-if="showCrl && !isDeputy && !isSingleTem_LCEY && !isSingleTem_GZRY"
      >
        <div class="text-con">出入量统计</div>
      </div>
      <div
        v-if="showSetCreatePage()"
        class="item-box"
        flex="cross:center main:center"
        @click="setPage"
        style="width: 90px"
      >
        <div class="text-con">设置起始页({{ sheetInfo.sheetStartPage }})</div>
      </div>
      <div
        class="item-box"
        flex="cross:center main:center"
        @click="toPrint"
        v-if="
          (HOSPITAL_ID != 'guizhou' && !isDeputy && isShow()) ||
          HOSPITAL_ID == 'guizhou'
        "
      >
        <div class="text-con">打印预览</div>
      </div>
      <!-- <div class="item-box" flex="cross:center main:center" @click="toAllPrint">
        <div class="text-con">批量打印</div>
      </div>-->
      <div
        v-if="!isDeputy"
        class="item-box"
        flex="cross:center main:center"
        @click.stop="toPdfPrint"
        v-show="isDev && isShow()"
      >
        <div class="text-con">批量打印</div>
      </div>
      <div
        v-if="!isDeputy"
        class="item-box"
        flex="cross:center main:center"
        @click.stop="delSheet"
      >
        <div class="text-con">删除整单</div>
      </div>
      <div
        class="item-box"
        flex="cross:center main:center"
        @click.stop="createSheet"
        v-if="!isSingleTem && !isDeputy && isShow()"
      >
        <div class="text-con">新建记录单</div>
      </div>
      <div
        class="item-box"
        flex="cross:center main:center"
        @click="openStaticModal"
        v-if="HOSPITAL_ID == 'guizhou' && isDeputy"
      >
        <div class="text-con">出入量统计</div>
      </div>
      <div
        class="item-box"
        flex="cross:center main:center"
        @click.stop="syncVisitWithData"
        v-if="HOSPITAL_ID == 'guizhou'"
      >
        <div class="text-con">同步护理巡视</div>
      </div>
      <div
        :class="[hisDocPreview('main') ? 'right-btn' : 'item-box']"
        :id="[hisDocPreview('main') ? 'is-deputy-btn' : '']"
        style="background: antiquewhite"
        flex="cross:center main:center"
        @click.stop="backMainForm"
        v-if="isDeputy"
      >
        <div class="text-con">
          {{ HOSPITAL_ID == "guizhou" ? "护理记录单" : "切换主页" }}
        </div>
      </div>
      <div
        :class="[hisDocPreview('deputy') ? 'right-btn' : 'item-box']"
        :id="[hisDocPreview('deputy') ? 'is-deputy-btn' : '']"
        style="background: antiquewhite"
        flex="cross:center main:center"
        @click.stop="addDeputyForm"
        v-if="sheetInfo.selectBlock && sheetInfo.selectBlock.additionalCode"
      >
        <div class="text-con">
          {{ HOSPITAL_ID == "guizhou" ? "出入量记录单" : "切换副页" }}
        </div>
      </div>
      <div
        class="item-box"
        flex="cross:center main:center"
        @click.stop="openChart"
        v-if="
          (HOSPITAL_ID === 'huadu' ||
            HOSPITAL_ID === 'liaocheng' ||
            HOSPITAL_ID === 'wujing') &&
          this.$route.path.includes('singleTemperatureChart')
        "
      >
        <div class="text-con">体温曲线</div>
      </div>
      <!--北海的婴儿录入体温曲线-->
      <div
        class="item-box"
        flex="cross:center main:center"
        @click.stop="openBabyChat()"
        v-if="
          HOSPITAL_ID === 'beihairenyi' &&
          this.$route.path.includes('Baby_sheetPage')
        "
      >
        <div class="text-con">体温曲线</div>
      </div>
      <!-- <div
        class="item-box"
        flex="cross:center main:center"
        @click.stop="createTemperature"
        v-else
      >
        <div class="text-con">新建体温单</div>
      </div> -->
      <div flex-box="1"></div>
      <!-- <span class="label">护理记录：</span> -->
      <el-select
        v-if="!isDeputy"
        v-model="sheetInfo.selectBlock"
        @change="changeSelectBlock"
        value-key="id"
        placeholder="请选择护理记录单"
        class="select-con"
      >
        <div class="sheetSelect-con-sheet">
          <div class="head-con" flex="cross:stretch">
            <div class="col-1">记录单标题</div>
            <div class="col-2">科室</div>
            <div class="col-3">开始时间</div>
            <div class="col-4">页码</div>
            <!-- <div class="col-3">结束时间</div> -->
          </div>
          <el-option
            v-for="item in sheetBlockList"
            :key="item.id"
            :label="blockLabel(item, sheetBlockList.length)"
            :value="item"
          >
            <div class="list-con" flex="cross:stretch">
              <div class="col-1" :title="item.recordName">
                {{ item.recordName }}
              </div>
              <div class="col-2" :title="item.deptName">
                {{ item.deptName }}
              </div>
              <div class="col-3" :title="item.createTime">
                {{ item.createTime }}
              </div>
              <div class="col-4" :title="item.completeName">
                {{ item.pageIndex }} - {{ item.endPageIndex }}
              </div>
              <!-- <div class="col-3" :title="item.completeName">{{item.completeName}}</div> -->
            </div>
          </el-option>
        </div>
      </el-select>
      <!-- <span class="label">页码范围:</span> -->
      <div
        class="item-box"
        style="width: 85px"
        flex="cross:center main:center"
        v-if="!isDeputy || HOSPITAL_ID == 'guizhou'"
      >
        <el-autocomplete
          class="pegeSelect"
          icon="caret-bottom"
          placeholder="请输入页码"
          v-model="pageArea"
          :fetch-suggestions="querySearch"
        ></el-autocomplete>
      </div>
      <div
        class="item-box"
        style="width: 85px"
        flex="cross:center main:center"
        v-if="!isDeputy && ['huadu', 'beihairenyi'].includes(HOSPITAL_ID)"
      >
        <input
          class="pegeSelect"
          style="outline: none; border: none"
          placeholder="请输入页码"
          v-model="pageNum"
          @keydown="pageNumKeyDown"
        />
      </div>
      <!-- <div class="item-box" flex="cross:center main:center" @click="tofull">
            <div class="text-con">
              <span v-if="fullpage">关闭全屏</span>
              <span v-else>全屏</span>
            </div>
      </div>-->
      <div style="width: 5px"></div>
      <div
        class="right-btn"
        flex="cross:center main:center"
        @click="openRltbModal"
        v-if="HOSPITAL_ID == 'guizhou' && isDeputy"
      >
        <div class="text-con">
          <img src="./images/评估.png" alt />
          入量同步
        </div>
      </div>
      <div class="line" v-if="!isSingleTem_LCEY && !isDeputy"></div>
      <div style="width: 5px"></div>
      <div
        class="right-btn"
        flex="cross:center main:center"
        @click="emit('openEvalModel')"
        v-if="showCrl && !isSingleTem_LCEY && !isDeputy"
      >
        <div class="text-con">
          <img src="./images/评估.png" alt />
          评估同步
        </div>
      </div>
      <div class="line" v-if="!isSingleTem_LCEY && !isDeputy"></div>
      <div
        class="right-btn"
        flex="cross:center main:center"
        @click.stop="openTztbModal"
        v-if="!isSingleTem_LCEY && !isDeputy"
      >
        <div class="text-con">
          <img src="./images/体征.png" alt />
          体征同步
        </div>
      </div>
      <div
        class="line"
        v-if="HOSPITAL_ID == 'wujing' || HOSPITAL_ID == 'quzhou'"
      ></div>
      <div
        class="line"
        v-if="HOSPITAL_ID == 'guizhou' && sheetInfo.sheetType === 'common_gzry'"
      ></div>
      <div style="width: 5px"></div>
      <div
        class="right-btn"
        flex="cross:center main:center"
        @click.stop="openZxdtbModal"
        v-if="
          HOSPITAL_ID == 'wujing' ||
          HOSPITAL_ID == 'quzhou' ||
          HOSPITAL_ID == 'weixian' ||
          HOSPITAL_ID == 'liaocheng'
        "
      >
        <div class="text-con">
          <img src="./images/评估.png" alt />
          执行单同步
        </div>
      </div>
      <div
        class="right-btn"
        flex="cross:center main:center"
        @click.stop="openZxdtbModal"
        v-if="HOSPITAL_ID == 'guizhou' && sheetInfo.sheetType === 'common_gzry'"
      >
        <div class="text-con">
          <img src="./images/评估.png" alt />
          输血同步
        </div>
      </div>
      <div style="width: 5px"></div>
    </div>
    <patientInfo
      v-if="
        patientInfo.patientId &&
        !$route.path.includes('temperature') &&
        !$route.path.includes('Baby_sheetPage') &&
        HOSPITAL_ID != 'huadu'
      "
    ></patientInfo>
    <newFormModal ref="newFormModal"></newFormModal>
    <setTitleModal ref="setTitleModal"></setTitleModal>
    <tztbModal ref="tztbModal"></tztbModal>
    <rltbModal ref="rltbModal" :blockId="blockId"></rltbModal>
    <zxdtbModal
      ref="zxdtbModal"
      :blockId="blockId"
      :title="titleName"
    ></zxdtbModal>
    <patientInfoModal ref="patientInfoModal"></patientInfoModal>
    <!-- <sweet-modal
      ref="sheet"
      title="体温曲线"
      class="tempSweetModal"
      @close="closeModal"
    > -->
    <moveContext
      :id="'temperatureChart'"
      :titlex="'体温曲线'"
      class="babyChat"
      v-if="
        this.$route.path.includes('singleTemperatureChart') &&
        HOSPITAL_ID == 'huadu'
      "
    >
      <temperatureHD :queryTem="patientInfo"></temperatureHD>
    </moveContext>
    <!-- </sweet-modal> -->
  </div>
</template>

<script>
import bus from "vue-happy-bus";
import $ from "jquery";
import setPageModal from "../modal/setPage-modal.vue";
import sheetModel, { cleanData } from "../../sheet.js";
import sheetInfo from "../config/sheetInfo/index.js";
import { sign } from "@/api/sheet.js";
import { Tr } from "../render/Body.js";
import {
  blockList,
  blockDelete,
  toPdfPrint,
  blockSave,
  switchAdditionalBlock,
} from "../../api/index.js";
import commom from "@/common/mixin/common.mixin.js";
import newFormModal from "../modal/new-sheet-modal.vue";
import setTitleModal from "../modal/set-title-modal.vue";
import tztbModal from "../modal/tztb-modal.vue";
import zxdtbModal from "../modal/zxdtb-modal.vue";
import rltbModal from "../modal/rltb-modal.vue";
import patientInfoModal from "./modal/patient-info-modal";
import dayjs from "dayjs";
// import lodopPrint from "./lodop/lodopPrint";
import patientInfo from "./patient-info";
import temperatureHD from "../../../patientInfo/supPage/temperature/temperatureHD";
//体温曲线窗口
import moveContext from "@/Page/temperature-chart/commonCompen/removableBox.vue";
import temperatureLCEY from "../../../patientInfo/supPage/temperature/temperatureLCEY";
import temperatureWuJing from "../../../patientInfo/supPage/temperature/temperatureWuJing";
import temperatureDghl from "../../../patientInfo/supPage/temperature/temperatureDghl";
import { getPatientInfo } from "@/api/common.js";
import Temperature from "@/Page/patientInfo/supPage/temperature/temperature.vue";

export default {
  mixins: [commom],
  name: "sheetTool",
  data() {
    return {
      bus: bus(this),
      tool: "",
      showCurve: false,
      creator: "",
      user: JSON.parse(localStorage.user),
      selectList: [],
      pageArea: "",
      sheetModel,
      sheetInfo,
      sheetBlockList: [],
      queryTem: {},
      titleName: "",
      pageNum: "",
      firstPage: 1,
    };
  },
  methods: {
    pageNumKeyDown(e) {
      if (e.keyCode == 13) {
        let startPage = Number(this.pageNum);
        let endPage = Number(this.pageNum);
        let tempPage = startPage;
        let currentPageArr = this.selectList.forEach((item) => {
          if (item.value) {
            let fromPage = item.value.split("-")[0];
            let toPage = item.value.split("-")[1];
            if (fromPage <= startPage) {
              tempPage = fromPage;
              endPage = toPage;
            }
          }
        });
        let count = startPage - tempPage;
        let scrollTop = 0;
        if (count != 0) {
          scrollTop = 722 * count + 20 * count;
        }
        startPage = tempPage;
        this.pageArea = `${startPage}-${endPage}`;
        setTimeout(() => {
          $(this.$parent.$refs.scrollCon).animate({
            scrollTop: scrollTop,
          });
        });
      }
    },
    showSetCreatePage() {
      return !this.isDeputy || this.HOSPITAL_ID == "guizhou";
    },
    //是否显示
    isShow() {
      if (
        this.HOSPITAL_ID === "beihairenyi" &&
        this.$route.path.includes("Baby_sheetPage")
      ) {
        return false;
      } else {
        return true;
      }
    },
    /* 出入量统计弹框--花都区分 */
    openStaticModal() {
      switch (process.env.HOSPITAL_ID) {
        case "huadu":
          this.bus.$emit("openHDModal");
          break;
        case "guizhou":
          this.bus.$emit("openGuizhouModal");
          break;
        default:
          this.bus.$emit("openHJModal");
          break;
      }
    },
    /* 打开体温曲线页面 */
    openChart() {
      this.queryTem = {
        admissionDate: this.sheetInfo.selectBlock.admissionDate,
        patientId: this.sheetInfo.selectBlock.patientId,
        visitId: this.sheetInfo.selectBlock.visitId,
      };
      this.$store.commit("newDialogVisible", true); //打开体温曲线
    },
    /* 打开婴儿的体温曲线页面 */
    openBabyChat() {
      this.$store.commit("showBabyChat", true);
      this.$store.commit("newDialogVisible", true);
    },

    emit(todo, value) {
      if (!this.patientInfo.patientId) {
        return this.$message.warning("请选择一名患者");
      }
      if (this.sheetInfo.sheetType != "body_temperature_Hd") {
        if (this.readOnly) {
          return this.$message.warning("你无权操作此护记，仅供查阅");
        }
      }
      this.bus.$emit(todo, value);
    },

    tofull() {
      this.$store.commit("upSheetPageFullpage", !this.fullpage);
    },
    toPrint() {
      if (!this.sheetInfo.selectBlock.id)
        return this.$message.warning("还没有选择护理记录单");

      if (
        process.env.HOSPITAL_ID == "fuyou" ||
        process.env.HOSPITAL_ID == "quzhou" ||
        process.env.HOSPITAL_ID == "huadu" ||
        process.env.HOSPITAL_ID === "foshanrenyi"
      ) {
        this.bus.$emit("toSheetPrintPage");
      } else {
        if (process.env.NODE_ENV == "production") {
          let newWid;
          if (!$(".sign-text").length) {
            newWid = window.open();
            return this.bus.$emit("toSheetPrintPage", newWid);
          }
          if (
            $(".mark-mark-mark").length == 0 &&
            $(".noSignRow").length == 0 &&
            $(".multiSign").length == 0
          ) {
            newWid = window.open();
          }
          this.bus.$emit("toSheetPrintPage", newWid);
        } else {
          this.bus.$emit("toSheetPrintPage");
        }
      }
    },
    toAllPrint() {
      let pageIndex = 0;
      let pageLength = this.selectList.length;
      let htmlArr = [];
      function getHtml() {
        this.pageArea = this.selectList[pageIndex].value;
        this.$nextTick(() => {
          $(".sheet-page-container").each((index, el) => {
            let htmlText = el.outerHTML;
            htmlArr.push(htmlText);
          });
          pageIndex++;
          if (pageIndex < pageLength) {
            getHtml.call(this);
          } else {
            lodopPrint(htmlArr);
          }
        });
      }

      getHtml.call(this);
    },
    setPage() {
      if (!this.patientInfo.patientId) {
        return this.$message.warning("请选择一名患者");
      }
      if (!this.sheetInfo.selectBlock.id) {
        return this.$message.warning("还没有选择护理记录单");
      }
      this.bus.$emit("openSetPageModal");
    },
    initSelectList() {
      let length = this.sheetModel.length + this.sheetInfo.sheetStartPage;
      let pagelist = [];
      let rest_num = this.sheetInfo.sheetStartPage % 10;
      let num = Math.ceil(Math.max(length / 10, 1));
      for (let i = 0; i <= num; i++) {
        if (i * 10 + rest_num >= length) {
          pagelist.push(length);
          break;
        }
        if ((i + 1) * 10 >= this.sheetInfo.sheetStartPage) {
          pagelist.push(i * 10 + rest_num);
        }
      }
      pagelist[0] = this.sheetInfo.sheetStartPage;
      pagelist[pagelist.length - 1] = length;
      this.selectList = [];
      for (let i = 0; i < pagelist.length; i++) {
        if (i == pagelist.length - 1) {
        } else if (i == pagelist.length - 2) {
          this.selectList.push({
            value: `${pagelist[i]}-${pagelist[i + 1] - 1}`,
          });
        } else if (pagelist[i] <= pagelist[i + 1] - 1) {
          this.selectList.push({
            value: `${pagelist[i]}-${pagelist[i + 1] - 1}`,
          });
        }
      }
      /* 刷新block分页信息 */
      if (
        this.patientInfo.patientId &&
        this.patientInfo.visitId &&
        this.deptCode
      ) {
        blockList(
          this.patientInfo.patientId,
          this.patientInfo.visitId,
          this.deptCode
        ).then((res) => {
          this.sheetBlockList.forEach((item) => {
            try {
              let currObj = res.data.data.list.find((obj) => obj.id == item.id);
              item.pageIndex = currObj.pageIndex;
              item.endPageIndex = currObj.endPageIndex;
            } catch (error) {}
          });
        });
      }
    },
    querySearch(queryString, cb) {
      this.initSelectList();
      cb(this.selectList);
    },
    getPrev(index, bodyModel, val) {
      if (index < 0) return "";
      let tr = bodyModel[index];
      let value = tr.find((item) => {
        return item.key == val;
      }).value;
      if (value) {
        return value;
      } else {
        return this.getPrev(index - 1, bodyModel, val);
      }
    },
    getAllListAndCurrIndex(trArr) {
      let allList = [];
      let currIndex = 0;
      for (let i = 0; i < sheetModel.length; i++) {
        allList = allList.concat(sheetModel[i].bodyModel);
      }
      currIndex = allList.indexOf(trArr);
      return [allList, currIndex];
    },
    toMoreSign() {
      if (this.sheetInfo.selectRow.length) {
        window.openSignModal((password, empNo, signDate, dsvsRandom) => {
          let list = [];
          for (let trArr of this.sheetInfo.selectRow) {
            let trObj = {};
            for (let i = 0; i < trArr.length; i++) {
              trObj[trArr[i].key] = trArr[i].value;
            }
            let [allList, currIndex] = this.getAllListAndCurrIndex(trArr);
            list.push(
              Object.assign({}, trObj, {
                recordMonth: this.getPrev(currIndex, allList, "recordMonth"),
                recordHour: this.getPrev(currIndex, allList, "recordHour"),
                recordYear: this.getPrev(currIndex, allList, "recordYear"),
                patientId: this.patientInfo.patientId,
                visitId: this.patientInfo.visitId,
                pageIndex: this.index,
              })
            );
          }
          let data = {
            empNo,
            password,
            list,
            dsvsRandom,
          };
          sign(this.patientInfo.patientId, this.patientInfo.visitId, data).then(
            (res) => {
              for (let i = 0; i < res.data.data.length; i++) {
                let trArrClone = Tr(res.data.data[i]);
                let trArr = sheetInfo.selectRow[i];
                if (
                  trArr.find((item) => {
                    return item.key == "recordMonth";
                  }).value == ""
                ) {
                  trArrClone.find((item) => {
                    return item.key == "recordMonth";
                  }).value = "";
                }
                if (
                  trArr.find((item) => {
                    return item.key == "recordHour";
                  }).value == ""
                ) {
                  trArrClone.find((item) => {
                    return item.key == "recordHour";
                  }).value = "";
                }
                trArr.splice(0, trArr.length);
                for (let i = 0; i < trArrClone.length; i++) {
                  trArr.push(trArrClone[i]);
                }
              }
              this.sheetInfo.selectRow.splice(
                0,
                this.sheetInfo.selectRow.length
              );
              this.$notify.success({
                title: "提示",
                message: "批量签名成功",
              });
              this.bus.$emit("saveSheetPage");
            }
          );
        });
      } else {
        this.$alert("请按下 ctrl 键并单击选择需要签名的行", "批量签名提示", {
          confirmButtonText: "确定",
          callback: (action) => {},
        });
      }
    },
    toMoreAduit() {
      if (this.sheetInfo.selectRow.length) {
        window.openSignModal((password, empNo) => {
          let list = [];
          for (let trArr of this.sheetInfo.selectRow) {
            let trObj = {};
            for (let i = 0; i < trArr.length; i++) {
              trObj[trArr[i].key] = trArr[i].value;
            }
            let [allList, currIndex] = this.getAllListAndCurrIndex(trArr);
            list.push(
              Object.assign({}, trObj, {
                recordMonth: this.getPrev(currIndex, allList, "recordMonth"),
                recordHour: this.getPrev(currIndex, allList, "recordHour"),
                recordYear: this.getPrev(currIndex, allList, "recordYear"),
                patientId: this.patientInfo.patientId,
                visitId: this.patientInfo.visitId,
                pageIndex: this.index,
              })
            );
          }
          let data = {
            empNo,
            password,
            list,
            audit: true,
          };
          sign(this.patientInfo.patientId, this.patientInfo.visitId, data).then(
            (res) => {
              for (let i = 0; i < res.data.data.length; i++) {
                let trArrClone = Tr(res.data.data[i]);
                let trArr = sheetInfo.selectRow[i];
                if (
                  trArr.find((item) => {
                    return item.key == "recordMonth";
                  }).value == ""
                ) {
                  trArrClone.find((item) => {
                    return item.key == "recordMonth";
                  }).value = "";
                }
                if (
                  trArr.find((item) => {
                    return item.key == "recordHour";
                  }).value == ""
                ) {
                  trArrClone.find((item) => {
                    return item.key == "recordHour";
                  }).value = "";
                }
                trArr.splice(0, trArr.length);
                for (let i = 0; i < trArrClone.length; i++) {
                  trArr.push(trArrClone[i]);
                }
              }
              this.sheetInfo.selectRow.splice(
                0,
                this.sheetInfo.selectRow.length
              );
              this.$notify.success({
                title: "提示",
                message: "批量审核成功",
              });
              this.bus.$emit("saveSheetPage");
            }
          );
        });
      } else {
        this.$alert("请按下 ctrl 键并单击选择需要签名的行", "批量签名提示", {
          confirmButtonText: "确定",
          callback: (action) => {},
        });
      }
    },
    async getBlockList() {
      if (this.$route.path.includes("nursingPreview")) {
        let { data } = await getPatientInfo(
          this.$route.query.patientId,
          this.$route.query.visitId
        );
        this.$store.commit("upDeptCode", data.data.wardCode);
      }
      console.log(
        "条件",
        this.patientInfo.patientId && this.patientInfo.visitId && this.deptCode
      );
      if (
        this.patientInfo.patientId &&
        this.patientInfo.visitId &&
        this.deptCode
      ) {
        blockList(
          this.patientInfo.patientId,
          this.patientInfo.visitId,
          this.deptCode
        ).then((res) => {
          this.bus.$emit("setSheetTableLoading", false);
          this.selectList = [];
          let list = res.data.data.list;
          if (
            this.$route.path.includes("singleTemperatureChart") ||
            this.$route.path.includes("temperature") ||
            this.$route.path.includes("Baby_sheetPage")
          ) {
            this.sheetBlockList = list.filter((item) => {
              switch (this.HOSPITAL_ID) {
                case "huadu":
                  return item.recordCode === "body_temperature_Hd";
                case "fuyou":
                  return item.recordCode === "body_temperature_jm";
                case "hj":
                  return item.recordCode === "body_temperature_hj";
                case "beihairenyi":
                  return item.recordCode === "infant_bh";
                // case "hengli":
                //   return item.recordCode === "body_temperature_hl";
                case "beihairenyi":
                  return item.recordCode === "body_temperature_bhry";
                case "wujing":
                  return item.recordCode === "body_temperature_wj";
                default:
                  break;
              }
              // return this.HOSPITAL_ID === "huadu" ||
              //   this.HOSPITAL_ID === "wujing"
              //   ? item.recordCode === "body_temperature_Hd"
              //   : item.recordCode === "body_temperature_lcey";
              // return item.recordCode == "body_temperature_Hd";
            });
          } else {
            this.sheetBlockList = list.filter((item) => {
              // return item.recordCode != "body_temperature_Hd";
              return (
                (item.recordCode != "body_temperature_Hd") &
                (item.recordCode != "body_temperature_hj") &
                (item.recordCode != "body_temperature_hl") &
                (item.recordCode != "body_temperature_wj")
              );
            });
          }
          this.sheetInfo.selectBlock =
            this.sheetBlockList[this.sheetBlockList.length - 1] || {};
          if (this.patientInfo.blockId) {
            try {
              let index = this.sheetBlockList.findIndex(
                (item) => item.id == this.patientInfo.blockId
              );
              this.sheetInfo.selectBlock = this.sheetBlockList[index];
            } catch (e) {
              console.log(e);
            }
          }
          this.sheetInfo.sheetType = this.sheetInfo.selectBlock.recordCode;
          // this.bus.$emit('refreshSheetPage', true)
        });
      }
    },
    createSheet() {
      if (!this.patientInfo.patientId) {
        return this.$message.warning("请选择一名患者");
      }
      this.$refs.newFormModal.open();
    },
    createTemperature() {
      this.$refs.newFormModal.open();
      // blockSave(
      //   this.patientInfo.patientId,
      //   this.patientInfo.visitId,
      //   this.deptCode,
      //   this.sheetInfo.sheetType
      // ).then((res) => {
      //   this.bus.$emit("getBlockList");
      //   this.$message.success("创建成功");
      //   this.bus.$emit("setSheetTableLoading", true);
      // });
    },
    delSheet() {
      if (!this.sheetInfo.selectBlock.id)
        return this.$message.warning("还没有选择护理记录单");
      this.$confirm("此操作将永久删除该护理记录单, 是否继续?", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning",
      }).then(() => {
        blockDelete(this.sheetInfo.selectBlock.id).then((res) => {
          this.$message({
            type: "success",
            message: "删除成功!",
          });
          // 刷新
          this.getBlockList();
        });
      });
    },
    blockLabel(item, length) {
      // return `${item.recordName} ${dayjs(item.createTime).format("MM-DD")}`;
      return `${item.deptName} ${dayjs(item.createTime).format(
        "MM-DD"
      )}建 共${length}张
      `;
    },
    changeSelectBlock(item) {
      if (item) {
        localStorage.wardCode = item.deptCode;
      }
      this.sheetInfo.sheetType = this.sheetInfo.selectBlock.recordCode;
      this.blockId = item.id;
      cleanData();
      this.bus.$emit("refreshSheetPage", true);
    },
    /** pdf打印 */
    toPdfPrint() {
      if (sheetInfo.selectBlock.id) {
        window.open(
          `/crNursing/toPdfPrint?blockId=${sheetInfo.selectBlock.id}`
        );
      } else {
        this.$message.warning("没有可以打印的护理记录单");
      }

      // toPdfPrint(false).then(res => {

      //   // console.log(res, "res");
      // });
    },
    openTztbModal() {
      if (this.readOnly) {
        return this.$message.warning("你无权操作此护记，仅供查阅");
      }
      this.$refs.tztbModal.open();
    },
    openZxdtbModal() {
      if (this.readOnly) {
        return this.$message.warning("你无权操作此护记，仅供查阅");
      }
      if (this.HOSPITAL_ID == "guizhou") {
        this.titleName = "输血同步";
      } else {
        this.titleName = "执行单同步";
      }

      this.$refs.zxdtbModal.open();
    },
    openRltbModal() {
      if (this.readOnly) {
        return this.$message.warning("你无权操作此护记，仅供查阅");
      }
      this.$refs.rltbModal.open();
    },
    /* 切换主页 */
    async backMainForm() {
      const id = this.sheetInfo.selectBlock.id;
      const { data } = await switchAdditionalBlock(id);
      this.sheetInfo.selectBlock = data.data;
      this.changeSelectBlock(false);
    },
    /* 切换副页 */
    async addDeputyForm() {
      const id = this.sheetInfo.selectBlock.id;
      const { data } = await switchAdditionalBlock(id);
      this.sheetInfo.selectBlock = data.data;
      this.changeSelectBlock(false);
    },
    // 同步护理巡视
    syncVisitWithData() {
      this.$refs.patientInfoModal.open();
    },
    hisDocPreview(type) {
      switch (type) {
        case "deputy":
          return (
            this.HOSPITAL_ID == "guizhou" &&
            !this.isDeputy &&
            this.$route.path.includes("nursingPreview")
          );
        case "main":
          return (
            this.HOSPITAL_ID == "guizhou" &&
            this.isDeputy &&
            this.$route.path.includes("nursingPreview")
          );
        default:
          return false;
      }
    },
  },
  computed: {
    blockId: {
      get() {
        return this.sheetInfo.selectBlock.id;
      },
      set() {},
    },

    fullpage() {
      return this.$store.state.sheet.fullpage;
    },
    patientInfo() {
      return this.$store.state.sheet.patientInfo;
    },
    patientId() {
      return this.$store.state.sheet.patientInfo.id;
    },
    showCrl() {
      switch (this.sheetInfo.sheetType) {
        // case "trauma_orthopedics":
        // case "orthopedics":
        //   return false;
        default:
          return true;
      }
    },
    /** 只读模式 */
    readOnly() {
      try {
        return !this.userDeptList
          .map((item) => item.code)
          .includes(this.sheetInfo.selectBlock.deptCode);
      } catch (error) {
        return false;
      }
    },
    /* 监听路由是否是单个体温单 */
    isSingleTem() {
      return this.$route.path.includes("singleTemperatureChart");
    },
    /* 聊城二院体温单屏蔽三个功能：“出入量统计”、"评估同步"、“体征同步” */
    isSingleTem_LCEY() {
      return (
        this.HOSPITAL_ID === "liaocheng" &&
        this.$route.path.includes("singleTemperatureChart")
      );
    },
    /* 贵州人医“出入量统计”移入出入量记录单 */
    isSingleTem_GZRY() {
      return this.HOSPITAL_ID === "guizhou";
    },
    /* 是否是副页 */
    isDeputy() {
      return (
        this.sheetInfo.selectBlock && this.sheetInfo.selectBlock.additionalBlock
      );
    },
    /* 监听体温单曲线 */
    temperatureChart() {
      switch (this.HOSPITAL_ID) {
        case "huadu":
          return temperatureHD;
          break;
        case "liaocheng":
          return temperatureLCEY;
          break;
        case "wujing":
          return temperatureWuJing;
          // case "hengli":
          //   return temperatureDghl;
          break;
        default:
          break;
      }
    },
  },
  created() {
    this.bus.$on("initSheetPageSize", () => {
      let old_list_length = this.selectList.length;
      let old_list_index = this.selectList.findIndex(
        (item) => item.value == this.pageArea
      );
      this.initSelectList();
      let new_list_length = this.selectList.length;
      // 判断是否存在recodeId
      // 获取被标记的页数
      try {
        let index;
        if (this.patientInfo.recordId) {
          for (let i = 0; i < this.sheetModel.length; i++) {
            for (let j = 0; j < this.sheetModel[i].bodyModel.length; j++) {
              if (
                this.patientInfo.recordId ==
                this.sheetModel[i].bodyModel[j].find((item) => item.key == "id")
                  .value
              ) {
                index = i + this.sheetInfo.sheetStartPage;
              }
            }
          }
          for (let i = 0; i < this.selectList.length; i++) {
            let page = this.selectList[i].value.split("-");
            let startPage = Number(page[0]);
            let endPage = Number(page[1]);
            if (index >= startPage && index <= endPage) {
              this.pageArea = this.selectList[i].value || "";
              let todo = () => {
                $(this.$parent.$refs.scrollCon).animate({
                  scrollTop:
                    $(`[recordId='${this.patientInfo.recordId}']`)
                      .eq(0)
                      .offset().top +
                    this.$parent.$refs.scrollCon.scrollTop -
                    250,
                });
                $(`[recordId='${this.patientInfo.recordId}']`)
                  .eq(0)
                  .addClass("red-border");
              };
              this.$nextTick(() => {
                setTimeout(() => {
                  todo();
                }, 0);
                setTimeout(() => {
                  todo();
                }, 100);
                setTimeout(() => {
                  todo();
                  this.patientInfo.blockId = "";
                  this.patientInfo.recordId = "";
                }, 300);
              });
            }
          }
        } else {
          // 页码定位
          if (new_list_length != old_list_length) {
            this.pageArea =
              this.selectList[this.selectList.length - 1].value || "";
          } else {
            if (old_list_index != undefined) {
              this.pageArea = this.selectList[old_list_index].value || "";
            } else {
              this.pageArea =
                this.selectList[this.selectList.length - 1].value || "";
            }
          }
        }
      } catch (error) {}
    });
    this.bus.$on("toSheetMoreSign", () => {
      this.toMoreSign();
    });
    this.bus.$on("toSheetMoreAudit", () => {
      this.toMoreAduit();
    });
    this.bus.$on("getBlockList", () => {
      this.getBlockList();
    });
    document.onkeydown = (e) => {
      if (e.keyCode == 91 || e.keyCode == 17) {
        this.sheetInfo.downControl = true;
      }
    };
    document.onkeyup = (e) => {
      if (e.keyCode == 91 || e.keyCode == 17) {
        this.sheetInfo.downControl = false;
      }
    };
  },
  mounted() {
    document.querySelector("#sheet_body_con").addEventListener("click", () => {
      if (!this.sheetInfo.downControl) {
        this.sheetInfo.selectRow.splice(0, this.sheetInfo.selectRow.length);
      }
    });
    this.bus.$emit("sheetToolLoaded");
  },
  watch: {
    //更换选择患者，更新vuex的患者信息，重新在eventbug队列调用事件
    patientInfo(val) {
      if (this.$route.path.includes("singleTemperatureChart")) {
        this.$store.commit("upPatientInfo", val);
        this.bus.$emit("refreshImg");
        this.bus.$emit("refreshVitalSignList");
      }
    },
    pageArea() {
      let page = this.pageArea.split("-");
      let startPage = page[0];
      let endPage = page[1];
      if (startPage && endPage) {
        if (
          Number(endPage) - Number(startPage) >= 0 &&
          Number(endPage) - Number(startPage) <= 20
        ) {
          this.sheetInfo.startPage = startPage;
          this.sheetInfo.endPage = endPage;
        }
      }
    },
    "sheetInfo.startPage"() {
      $(this.$parent.$refs.scrollCon).animate({
        scrollTop: 0,
      });
    },
    patientId: {
      deep: true,
      handler() {
        if (this.patientInfo.patientId) {
          console.log(111);
          this.$parent.breforeQuit(() => {
            this.getBlockList();
            this.bus.$emit("setSheetTableLoading", true);
            // 初始化页面区间列表
            this.selectList = [];
          });
        }
      },
    },

    $route(to, from) {
      if (to.name != from.name) {
        this.getBlockList();
      }
    },
    pageNum(value) {
      let temPage = parseInt(Number(value) / 10);
      let count = parseInt(Number(value) % 10);
      if (temPage && count) {
        this.firstPage = temPage * 10 + 1;
      } else if (temPage == 0 && Number(value) == 0) {
        this.firstPage = 1;
      } else if (temPage && !count) {
        this.firstPage = (temPage - 1) * 10 + 1;
      }
    },
  },
  components: {
    setPageModal,
    newFormModal,
    setTitleModal,
    tztbModal,
    zxdtbModal,
    rltbModal,
    moveContext,
    patientInfoModal,
    patientInfo,
    temperatureHD,
    temperatureLCEY,
    temperatureWuJing,
    temperatureDghl,
    Temperature,
  },
};
</script>

<style
  lang="stylus"
  rel="stylesheet/stylus"
  type="text/stylus"
  src="./tool.styl"
  scoped
></style>

<style lang="stylus" scoped>
.pegeSelect {
  >>> .el-input__inner {
    border: 0 !important;
    font-size: 12px;
    color: #333333;
  }
}

.label {
  font-size: 12px;
  color: #333;
}
</style>

<style lang="stylus" rel="stylesheet/stylus" type="text/stylus" scoped>
.sheetSelect-con-sheet {
  background: #FFFFFF;
  box-shadow: 0 2px 6px 0 rgba(0, 0, 0, 0.5);
  border-radius: 4px;
  width: 562px !important;
  left: auto !important;
  right: 120px;

  .el-select-dropdown__list, .el-select-dropdown__item {
    padding: 0;
    height: auto;
  }

  .el-select-dropdown__wrap {
    max-height: 500px;
  }

  .head-con {
    height: 37px;
    background: #F7FAFA;
    border-bottom: 1px solid #EAEEF1;
    font-size: 13px;
    color: #333333;
    font-weight: bold;
  }

  .col-1, .col-2, .col-3, .col-4 {
    display: flex;
    align-items: center;
  }

  .col-1 {
    width: 192px;
    padding: 0 24px;
    border-right: 1px solid #EAEEF1;
  }

  .col-2 {
    width: 126px;
    padding: 0 16px;
    border-right: 1px solid #EAEEF1;
  }

  .col-3 {
    width: 133px;
    padding: 0 14px;
    border-right: 1px solid #EAEEF1;
  }

  .col-4 {
    width: 80px;
    padding: 0 14px;
  }

  .list-con {
    font-size: 13px;
    color: #333333;
    height: 37px;
    border-bottom: 1px solid #EAEEF1;
  }

  .el-select-dropdown__item.selected {
    background: #fff;
    position: relative;

    &:after {
      content: '';
      position: absolute;
      left: 0;
      top: 9px;
      height: 20px;
      width: 4px;
      background: #4bb08d;
    }
  }

  .el-select-dropdown__item.hover {
    background: #fff;
  }

  .el-select-dropdown__item:hover {
    background: #E5F1F0;
  }
}

.red-border {
  border: 2px solid red !important;
}

.tempSweetModal {
  /deep/ .sweet-modal {
    width: 90% !important;
    overflow: hidden !important;
  }

  /deep/ .sweet-content {
    background: #dfdfdf;
    max-height: 105vh !important;
  }
}

#is-deputy-btn {
  background: none !important;
  pointer-events: auto !important;
}

.babyChat {
  position: absolute;
  right: 0;
  top: 15px;
  width: 85%;
  height: 100%;
  z-index: 999;
  box-shadow: -2px 0 7px -1px black; // 左边阴影;
  background-color: white;
}
</style>
